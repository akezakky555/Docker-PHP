#
# Apache2 Virtual Host Configuration for serving static tiles
#
# tile.powermap.in.th / 54.169.209.204
#
#  http://redmine.aits.space/redmine/projects/web-product/wiki/BaseMap
#
# Basic checks:
#   http://tile.powermap.xyz/v1/tile/en/EPSG_900913_03/1_1/06_04.png
#   http://tile.powermap.xyz/v1/tile/th/EPSG_900913_03/1_1/06_04.png


<VirtualHost *:80>
	ServerName tile.powermap.in.th
	ServerAdmin chayapan.k@aapico.com
	DocumentRoot /home/powermap/public
	LogLevel info ssl:warn
	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

# Custom Error Document
    ErrorDocument 403 /assets/403-no-access.png
    ErrorDocument 404 /assets/404-no-coverage.png
    ErrorDocument 500 /assets/500-error.png

# Map Tile Server - Landing Page
<Directory /home/powermap/public>
    Require all granted
</Directory>

# Pre-rendered map tiles
#
#  /v1/tile/th/
#  /v1/tile/en/
#

Alias /v1/tile/th /map/powermap/PM_GeoMap_th
<Directory /map/powermap/PM_GeoMap_th>
    Require all granted
</Directory>

Alias /v1/tile/en /map/powermap/PM_GeoMap_en
<Directory /map/powermap/PM_GeoMap_en>
    Require all granted
</Directory>

</VirtualHost>

<VirtualHost *:443>
    SSLEngine On
    SSLCertificateFile /etc/letsencrypt/live/tile.powermap.in.th-0001/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/tile.powermap.in.th-0001/privkey.pem
    # SSLCACertificateFile /etc/ssl/certs/ca-certificates.crt  #If using a self-signed certificate, omit t$

    LogLevel info ssl:warn
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    ServerName tile.powermap.in.th
    ServerAdmin chayapan.k@aapico.com
    DocumentRoot /map/tile/powermap-tile/public

    ErrorDocument 403 /assets/403-no-access.png
    ErrorDocument 404 /assets/404-no-coverage.png
    ErrorDocument 500 /assets/500-error.png

<ifModule mod_expires.c>
  ExpiresActive On
  ExpiresDefault "access plus 1 seconds"
  ExpiresByType image/x-icon "access plus 2592000 seconds"
  ExpiresByType image/jpeg "access plus 2592000 seconds"
  ExpiresByType image/png "access plus 2592000 seconds"
  ExpiresByType image/gif "access plus 2592000 seconds"
  ExpiresByType application/x-shockwave-flash "access plus 2592000 seconds"
  ExpiresByType text/css "access plus 604800 seconds"
  ExpiresByType text/javascript "access plus 216000 seconds"
  ExpiresByType application/javascript "access plus 216000 seconds"
  ExpiresByType application/x-javascript "access plus 216000 seconds"
  ExpiresByType text/html "access plus 600 seconds"
  ExpiresByType application/xhtml+xml "access plus 600 seconds"
</ifModule>


    # Map Tile Server - Landing Page
    <Directory /map/tile/powermap-tile/public>
        Require all granted
    </Directory>

    # Pre-rendered map tiles
    #  /v1/tile/th/
    #  /v1/tile/en/
    # Basic checks:
    #   https://tile.powermap.in.th/v1/tile/en/EPSG_900913_03/1_1/06_04.png
    #   https://tile.powermap.in.th/v1/tile/th/EPSG_900913_03/1_1/06_04.png

# version 1
    Alias /v1/th /map/powermap/PM_GeoMap_th
    <Directory /map/powermap/PM_GeoMap_th>
        Require all granted
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteRule ^(.*).png$ /tile.php?path=$1&version=v1&language=th&label=PM_GeoMap_th [QSA,L]
    </Directory>

    Alias /v1/en /map/powermap/PM_GeoMap_en
    <Directory /map/powermap/PM_GeoMap_en>
        Require all granted
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteRule ^(.*).png$ /tile.php?path=$1&version=v1&language=th&label=PM_GeoMap_en [QSA,L]
    </Directory>

# Support ZXY OSM tile request

    # Support ZXY OSM tile request
    Alias /osm /map/tile/powermap-tile/osm
    <Directory /map/tile/powermap-tile/osm>
        Require all granted
        DirectoryIndex tile.php
        <IfModule mod_negotiation.c>
            Options -MultiViews
        </IfModule>
        RewriteEngine On
        # Redirect Trailing Slashes...
        RewriteRule ^(.*)/$ /$1 [L,R=301]
        # Handle Front Controller...
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^(.*)$ /osm/tile.php?path=$1 [QSA,L]
    </Directory>

# version 2
# API key
#
    Alias /v2/th /map/powermap/PM_Map_V2_T
    <Directory /map/powermap/PM_Map_V2_T>
        Require all granted
        DirectoryIndex v2th.php
        RewriteEngine On

        # check API key
        # If there is tile image, pass this request through PHP to check for API key
        # in tile.php. Support debug=1. Need key=API_KEY
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteRule ^(.*).png$ /tile.php?path=$1&version=v2&language=th [QSA,L]

        # If file doesn't exist, return default image.
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteRule ^(.*)$ /404-no-coverage.png [L,R=404]
    </Directory>

    Alias /v2/en /map/powermap/PM_Map_V2_E
    <Directory /map/powermap/PM_Map_V2_E>
        Require all granted
        DirectoryIndex v2en.php
    </Directory>



# Map tile EPSG900913 from GeoServer + GeoWebCache
#  /v1/tms/th/
#  /v1/tms/en/
#  
#  http://redmine.aapico-its.com/redmine/projects/mapserver/wiki/BaseLayer
# 
ProxyPass /v1/tms/th/  http://10.11.1.213:8080/geoserver/gwc/service/tms/1.0.0/PM:GeoMap_t@EPSG%3A900913@png/
ProxyPassReverse /v1/tms/th/  http://10.11.1.213:8000/geoserver/gwc/service/tms/1.0.0/PM:GeoMap_t@EPSG%3A900913@png/
ProxyPass /v1/tms/en/  http://10.11.1.213:8080/geoserver/gwc/service/tms/1.0.0/PM:GeoMap_e@EPSG%3A900913@png/
ProxyPassReverse /v1/tms/en/  http://10.11.1.213:8000/geoserver/gwc/service/tms/1.0.0/PM:GeoMap_e@EPSG%3A900913@png/



</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
